<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Page</title>
    <link href="../styles/QuizStyles.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- imported components -->
    <script type="module" src="main.jsx"></script>
</head>
<body>
    <div class="card-container quiz">
        <div class="upper-portion">
            <div class="short-container score-counter">
                <p id="score">Score: 0</p> 
            </div>
            <div id="quit-button" class="quit-btn">
                Quit
            </div>
        </div>
        <div id='question' class="question-container">
            <p id="sentence"></p>
        </div>

        <!-- options container START -->
        <div id="options" class="options-container">
        </div>
        <!-- options container END -->

        <!-- bottom portion START -->
        <div class="bottom-portion">
            <button id="next-button" class="small-btn">
                Next
            </button>
        </div>
        <!-- bottom portion END -->
    </div>

    <script>
        // At the top level of the script
        const questions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        $(document).ready(function() {
            // Remove duplicate variable declarations
            function fetchQuestions() {
                return fetch('http://localhost:5137/questions')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (Array.isArray(data) && data.length > 0) {
                            // Update the global questions array
                            questions.length = 0; // Clear existing questions
                            questions.push(...data); // Add new questions
                            currentQuestionIndex = 0;
                            score = 0;
                            $('#score').text(`Score: ${score}`);
                            loadQuestion();
                        } else {
                            console.error('No questions available');
                            alert('No questions available. Please upload a file first.');
                            window.location.href = 'index.html';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching questions:', error);
                        alert('Error loading questions. Please try again.');
                    });
            }

            function loadQuestion() {
                if (questions && currentQuestionIndex < questions.length) {
                    const question = questions[currentQuestionIndex];
                    $('#sentence').text(question.question || '');
                    $('#options').empty();
                    
                    if (question.options && Array.isArray(question.options)) {
                        const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);
                        shuffledOptions.forEach((option, index) => {
                            const optionButton = $('<button>')
                                .addClass('options-default')
                                .text(`${String.fromCharCode(65 + index)}. ${option}`)
                                .click(() => checkAnswer(option));
                            $('#options').append(optionButton);
                        });
                    }
                } else {
                    window.location.href = 'resultsPage.html';
                }
            }

            // Call fetchQuestions when page loads
            fetchQuestions();

            // Handle next button click
            $('#next-button').click(() => {
                currentQuestionIndex++;
                loadQuestion();
            });
        });

        // Function to check the answer
        function checkAnswer(selectedOption) {
            const question = questions[currentQuestionIndex];
            if (selectedOption && question) {
                if (selectedOption.trim() === question.answer.trim()) {
                    score++;
                    $('#score').text(`Score: ${score}`);
                }
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        let uploadedFile = null; // Variable to store the uploaded file

        function handleUpload() {
            if (uploadedFile) {
                const formData = new FormData();
                formData.append('pdfFile', uploadedFile); // Append the file to the form data

                fetch('http://localhost:5137/upload', {
                    method: 'POST',
                    body: formData // Send the form data
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    fetchQuestions(); // Fetch questions after upload
                    window.location.href = 'QuizPage.html';
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                alert("Please upload a PDF file first.");
            }
        }
    </script>
</body>
</html>